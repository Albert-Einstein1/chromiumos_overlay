From: Jordan Crouse <jcrouse@quicinc.com>

Implement swap interval support in DRI2 and various changes to support
DRI2 in x server 1.7.4.

---

 hw/xfree86/dri2/dri2.c    |    1 +
 hw/xfree86/dri2/dri2ext.c |    3 +++
 include/scrnintstr.h      |    2 ++
 3 files changed, 6 insertions(+), 0 deletions(-)


diff --git a/hw/xfree86/dri2/dri2.c b/hw/xfree86/dri2/dri2.c
index 587a928..4e6d851 100644
--- a/hw/xfree86/dri2/dri2.c
+++ b/hw/xfree86/dri2/dri2.c
@@ -644,6 +644,7 @@ DRI2SwapBuffers(ClientPtr client, DrawablePtr pDraw, CARD64 target_msc,
      */
     *swap_target = pPriv->last_swap_target + pPriv->swap_interval;
 
+    pScreen->swapInterval = pPriv->swap_interval;
     ret = (*ds->ScheduleSwap)(client, pDraw, pDestBuffer, pSrcBuffer,
 			      swap_target, divisor, remainder, func, data);
     if (!ret) {
diff --git a/hw/xfree86/dri2/dri2ext.c b/hw/xfree86/dri2/dri2ext.c
index ea887e4..7d9cd04 100644
--- a/hw/xfree86/dri2/dri2ext.c
+++ b/hw/xfree86/dri2/dri2ext.c
@@ -632,6 +632,9 @@ int DRI2EventBase;
 static void
 DRI2ExtensionInit(void)
 {
+    /* HACK alert to get to build with xorg-server-1.7.4 */
+
+    //dri2DrawableRes = CreateNewResourceType(DRI2DrawableGone, "DRI2Drawable");
     dri2DrawableRes = CreateNewResourceType(DRI2DrawableGone);
 
     if (!dri2DrawableRes)
diff --git a/include/scrnintstr.h b/include/scrnintstr.h
index ab50e7a..6a93d13 100644
--- a/include/scrnintstr.h
+++ b/include/scrnintstr.h
@@ -472,6 +472,8 @@ typedef struct _Screen {
     pointer		devPrivate;
     short       	numVisuals;
     VisualPtr		visuals;
+    /* The following is used to store a swap interval on a screen basis */
+    int         swapInterval;
 
     /* Random screen procedures */
 
